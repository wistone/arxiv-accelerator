name: è‡ªåŠ¨å¤‡ä»½æ—¥å¿—åˆ†ææ–‡ä»¶

on:
  schedule:
    # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡å¤‡ä»½ (UTCæ—¶é—´)
    - cron: '0 */1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
  actions: read    # å…è®¸è¯»å–Actions

jobs:
  backup-logs:
    runs-on: ubuntu-latest
    name: å¤‡ä»½åˆ†ææ–‡ä»¶åˆ°Git
    
    steps:
      - name: ğŸ” æ£€æŸ¥ä»“åº“ç¯å¢ƒ
        run: |
          echo "ğŸ“Š GitHub Actionsç¯å¢ƒä¿¡æ¯:"
          echo "   - ä»“åº“: ${{ github.repository }}"
          echo "   - åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   - è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "   - å·¥ä½œæµ: ${{ github.workflow }}"
          echo "   - è¿è¡ŒID: ${{ github.run_id }}"

      - name: ğŸ” éªŒè¯å¯†é’¥é…ç½®
        run: |
          if [ -z "${{ secrets.BACKUP_SECRET }}" ]; then
            echo "âŒ é”™è¯¯: BACKUP_SECRETæœªé…ç½®"
            echo "ğŸ’¡ è¯·åœ¨ä»“åº“Settings â†’ Secretsä¸­æ·»åŠ BACKUP_SECRETå¯†é’¥"
            exit 1
          fi
          echo "âœ… å¤‡ä»½å¯†é’¥å·²é…ç½®"

      - name: ğŸ“¥ Checkout ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ”§ é…ç½® Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: ğŸ©º å¥åº·æ£€æŸ¥å’ŒæœåŠ¡å”¤é†’
        id: health_check
        run: |
          echo "ğŸ©º æ£€æŸ¥RenderæœåŠ¡å¥åº·çŠ¶æ€..."
          BASE_URL="https://arxiv-accelerator.onrender.com"
          
          # å¥åº·æ£€æŸ¥å‡½æ•°
          check_service_health() {
            local url="$1"
            local timeout="${2:-30}"
            
            echo "ğŸ” æ£€æŸ¥æœåŠ¡: $url (è¶…æ—¶: ${timeout}ç§’)" >&2
            
            # ä½¿ç”¨è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´æ£€æŸ¥æœåŠ¡çŠ¶æ€
            local response=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" \
              --max-time $timeout \
              --connect-timeout 10 \
              "$url" 2>/dev/null || echo "000:0")
            
            local status_code=$(echo "$response" | cut -d':' -f1)
            local response_time=$(echo "$response" | cut -d':' -f2)
            
            echo "ğŸ“Š çŠ¶æ€ç : $status_code, å“åº”æ—¶é—´: ${response_time}ç§’" >&2
            # åªè¿”å›çŠ¶æ€ç åˆ°stdout
            echo "$status_code"
          }
          
          # å°è¯•å¤šæ¬¡å¥åº·æ£€æŸ¥ï¼Œç­‰å¾…æœåŠ¡å°±ç»ª
          echo "ğŸ”„ å¼€å§‹æœåŠ¡å¥åº·æ£€æŸ¥ (æœ€å¤šç­‰å¾…120ç§’)..."
          
          for attempt in {1..8}; do
            echo "ğŸƒ ç¬¬ $attempt æ¬¡æ£€æŸ¥..."
            
            # æ£€æŸ¥æ ¹è·¯å¾„
            status=$(check_service_health "$BASE_URL/" 15)
            
            case $status in
              200|404|302|301)
                echo "âœ… æœåŠ¡å·²å°±ç»ª! (çŠ¶æ€ç : $status)"
                echo "service_ready=true" >> $GITHUB_OUTPUT
                break
                ;;
              502|503|521|522|523|524)
                echo "â³ æœåŠ¡æ­£åœ¨å¯åŠ¨ä¸­... (çŠ¶æ€ç : $status)"
                if [ $attempt -lt 8 ]; then
                  echo "ğŸ˜´ ç­‰å¾…15ç§’åé‡è¯•..."
                  sleep 15
                else
                  echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶ï¼Œä½†å°†å°è¯•è°ƒç”¨å¤‡ä»½API"
                  echo "service_ready=false" >> $GITHUB_OUTPUT
                fi
                ;;
              000)
                echo "ğŸ”Œ æ— æ³•è¿æ¥åˆ°æœåŠ¡ï¼Œå¯èƒ½æ­£åœ¨å†·å¯åŠ¨..."
                if [ $attempt -lt 8 ]; then
                  echo "ğŸ˜´ ç­‰å¾…15ç§’åé‡è¯•..."
                  sleep 15
                else
                  echo "âŒ è¿æ¥è¶…æ—¶ï¼Œä½†å°†å°è¯•è°ƒç”¨å¤‡ä»½API"
                  echo "service_ready=false" >> $GITHUB_OUTPUT
                fi
                ;;
              *)
                echo "âš ï¸  æœªçŸ¥çŠ¶æ€ç : $status"
                if [ $attempt -lt 8 ]; then
                  echo "ğŸ˜´ ç­‰å¾…10ç§’åé‡è¯•..."
                  sleep 10
                else
                  echo "â“ çŠ¶æ€æœªçŸ¥ï¼Œå°†å°è¯•è°ƒç”¨å¤‡ä»½API"
                  echo "service_ready=false" >> $GITHUB_OUTPUT
                fi
                ;;
            esac
          done

      - name: ğŸŒ è·å–RenderæœåŠ¡å™¨çš„æ–‡ä»¶
        id: get_files
        run: |
          echo "ğŸš€ å¼€å§‹ä»Renderè·å–åˆ†ææ–‡ä»¶..."
          
          # è®¡ç®—HMACç­¾å
          SIGNATURE=$(echo -n "run" | openssl dgst -sha256 -hmac "${{ secrets.BACKUP_SECRET }}" | cut -d' ' -f2)
          echo "ğŸ” ç­¾åå·²ç”Ÿæˆ"
          
          # è®¾ç½®è°ƒè¯•æ¨¡å¼ï¼ˆé¿å…è¾“å‡ºå¤§é‡å“åº”å†…å®¹ï¼‰
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            echo "ğŸ› è°ƒè¯•æ¨¡å¼å·²å¯ç”¨"
            CURL_OPTIONS="--verbose --stderr /tmp/curl_debug.log"
            echo "ğŸ“ curlè¯¦ç»†æ—¥å¿—å°†ä¿å­˜åˆ° /tmp/curl_debug.logï¼ˆä¸åœ¨Actionæ—¥å¿—ä¸­æ˜¾ç¤ºï¼‰"
          else
            CURL_OPTIONS="-s"
          fi
          
          # å¢å¼ºçš„å¤‡ä»½APIè°ƒç”¨å‡½æ•°
          call_backup_api() {
            local attempt=$1
            local timeout="${2:-60}"
            
            echo "ğŸ“¡ ç¬¬ $attempt æ¬¡è°ƒç”¨å¤‡ä»½API (è¶…æ—¶: ${timeout}ç§’)..."
            
            curl -X POST \
              -H "X-Backup-Sign: $SIGNATURE" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Actions-Backup-Bot/1.0" \
              $CURL_OPTIONS \
              --max-time $timeout \
              --connect-timeout 30 \
              -w "HTTP_STATUS:%{http_code}" \
              https://arxiv-accelerator.onrender.com/internal/backup
          }
          
          # æ‰§è¡Œå¸¦é‡è¯•çš„APIè°ƒç”¨
          MAX_ATTEMPTS=3
          SUCCESS=false
          
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "ğŸ¯ å¼€å§‹ç¬¬ $attempt/$MAX_ATTEMPTS æ¬¡APIè°ƒç”¨å°è¯•..."
            
            # è°ƒç”¨API
            RESPONSE=$(call_backup_api $attempt)
            
            # åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ˜¾ç¤ºcurlæ—¥å¿—æ‘˜è¦ï¼ˆä¸æ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼‰
            if [ "${{ github.event.inputs.debug }}" = "true" ] && [ -f /tmp/curl_debug.log ]; then
              echo "ğŸ” curlè¿æ¥æ‘˜è¦:"
              grep -E "(Connected to|Server certificate|< HTTP)" /tmp/curl_debug.log | head -5 || echo "æ— è¿æ¥ä¿¡æ¯"
              rm -f /tmp/curl_debug.log
            fi
            
            # è§£æå“åº”
            HTTP_STATUS=$(echo "$RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
            RESPONSE_BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
            
            echo "ğŸ“Š APIå“åº”çŠ¶æ€: $HTTP_STATUS"
            
            # åˆ¤æ–­å“åº”çŠ¶æ€
            case $HTTP_STATUS in
              200)
                echo "âœ… APIè°ƒç”¨æˆåŠŸ!"
                SUCCESS=true
                break
                ;;
              502|503|521|522|523|524)
                echo "â³ æœåŠ¡æ­£åœ¨å¯åŠ¨ä¸­ï¼ŒAPIæš‚æ—¶ä¸å¯ç”¨ (çŠ¶æ€ç : $HTTP_STATUS)"
                if [ $attempt -lt $MAX_ATTEMPTS ]; then
                  echo "ğŸ˜´ ç­‰å¾…30ç§’åé‡è¯•..."
                  sleep 30
                else
                  echo "âŒ æ‰€æœ‰APIè°ƒç”¨å°è¯•éƒ½å¤±è´¥äº†"
                fi
                ;;
              000)
                echo "ğŸ”Œ æ— æ³•è¿æ¥åˆ°APIï¼ŒæœåŠ¡å¯èƒ½æ­£åœ¨é‡å¯"
                if [ $attempt -lt $MAX_ATTEMPTS ]; then
                  echo "ğŸ˜´ ç­‰å¾…20ç§’åé‡è¯•..."
                  sleep 20
                else
                  echo "âŒ è¿æ¥æŒç»­å¤±è´¥"
                fi
                ;;
              403)
                echo "âŒ ç­¾åéªŒè¯å¤±è´¥ï¼Œä¸å†é‡è¯•"
                break
                ;;
              *)
                echo "âš ï¸  æœªçŸ¥é”™è¯¯ (çŠ¶æ€ç : $HTTP_STATUS)"
                if [ $attempt -lt $MAX_ATTEMPTS ]; then
                  echo "ğŸ˜´ ç­‰å¾…15ç§’åé‡è¯•..."
                  sleep 15
                else
                  echo "âŒ æœªçŸ¥é”™è¯¯æŒç»­å­˜åœ¨"
                fi
                ;;
            esac
          done
          
          # æœ€ç»ˆç»“æœå¤„ç†
          if [ "$SUCCESS" = "true" ]; then
            echo "ğŸ‰ å¤‡ä»½APIè°ƒç”¨æˆåŠŸ!"
            
            # æ˜¾ç¤ºå“åº”æ¦‚è¦ä¿¡æ¯ï¼ˆä¸æ˜¾ç¤ºå…·ä½“å†…å®¹ï¼‰
            RESPONSE_LENGTH=$(echo "$RESPONSE_BODY" | wc -c)
            echo "ğŸ“Š APIå“åº”é•¿åº¦: $RESPONSE_LENGTH å­—ç¬¦"
            
            # åªæ˜¾ç¤ºJSONç»“æ„æ¦‚è¦ï¼Œä¸æ˜¾ç¤ºå…·ä½“å†…å®¹
            RESPONSE_KEYS=$(echo "$RESPONSE_BODY" | jq -r 'keys[]' 2>/dev/null | tr '\n' ',' | sed 's/,$//' || echo "æ— æ³•è§£æ")
            echo "ğŸ” APIå“åº”å­—æ®µ: [$RESPONSE_KEYS]"
            
            # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
            if [ -z "$RESPONSE_BODY" ]; then
              echo "âŒ APIå“åº”ä¸ºç©º"
              echo "has_files=false" >> $GITHUB_OUTPUT
              echo "api_failed=true" >> $GITHUB_OUTPUT
            else
              # ä¿å­˜å“åº”åˆ°æ–‡ä»¶
              echo "$RESPONSE_BODY" > backup_response.json
              
              # å°è¯•è§£æJSONï¼Œæ·»åŠ é”™è¯¯å¤„ç†
              echo "ğŸ” å¼€å§‹è§£æJSONå“åº”..."
              
              # æ£€æŸ¥APIæ˜¯å¦è¿”å›æˆåŠŸçŠ¶æ€
              API_OK=$(echo "$RESPONSE_BODY" | jq -r '.ok // false' 2>/dev/null)
              if [ "$API_OK" != "true" ]; then
                echo "âŒ APIå“åº”çŠ¶æ€ä¸ºfalseæˆ–æœªå®šä¹‰"
                # åªæ˜¾ç¤ºæ¦‚è¦ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºå®Œæ•´å†…å®¹
                API_MESSAGE=$(echo "$RESPONSE_BODY" | jq -r '.message // "æ— æ¶ˆæ¯"' 2>/dev/null)
                echo "ğŸ” APIæ¶ˆæ¯: $API_MESSAGE"
                echo "ğŸ“Š å“åº”é•¿åº¦: $(echo "$RESPONSE_BODY" | wc -c) å­—ç¬¦"
                echo "has_files=false" >> $GITHUB_OUTPUT
                echo "api_failed=true" >> $GITHUB_OUTPUT
              else
                echo "âœ… APIå“åº”çŠ¶æ€æ­£å¸¸ (ok: true)"
                
                # å°è¯•è·å–æ–‡ä»¶æ•°é‡ï¼Œæ”¯æŒå¤šç§å­—æ®µ
                FILE_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.file_count // (.files | length) // 0' 2>/dev/null)
                
                if [ -z "$FILE_COUNT" ] || [ "$FILE_COUNT" = "null" ]; then
                  echo "âš ï¸  æ— æ³•è§£ææ–‡ä»¶æ•°é‡ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ³•..."
                  # å¤‡é€‰æ–¹æ³•ï¼šç›´æ¥è®¡ç®—fileså¯¹è±¡çš„é”®æ•°é‡
                  FILE_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.files | keys | length' 2>/dev/null || echo "0")
                fi
                
                echo "ğŸ“„ è§£æåˆ°çš„æ–‡ä»¶æ•°é‡: $FILE_COUNT"
                
                # éªŒè¯FILE_COUNTæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
                if [[ "$FILE_COUNT" =~ ^[0-9]+$ ]] && [ "$FILE_COUNT" -gt 0 ]; then
                  echo "has_files=true" >> $GITHUB_OUTPUT
                  echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
                  echo "âœ… å‘ç° $FILE_COUNT ä¸ªéœ€è¦å¤‡ä»½çš„æ–‡ä»¶"
                else
                  echo "has_files=false" >> $GITHUB_OUTPUT
                  echo "â„¹ï¸  æ²¡æœ‰éœ€è¦å¤‡ä»½çš„æ–‡ä»¶ (æ–‡ä»¶æ•°é‡: $FILE_COUNT)"
                fi
              fi
            fi
          else
            echo "âŒ å¤‡ä»½APIè°ƒç”¨æœ€ç»ˆå¤±è´¥!"
            # åªæ˜¾ç¤ºæ¦‚è¦ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºå®Œæ•´å“åº”å†…å®¹
            RESPONSE_LENGTH=$(echo "$RESPONSE_BODY" | wc -c)
            echo "ğŸ“Š é”™è¯¯å“åº”é•¿åº¦: $RESPONSE_LENGTH å­—ç¬¦"
            if [ "$RESPONSE_LENGTH" -lt 500 ]; then
              echo "ğŸ“„ é”™è¯¯å“åº”æ¦‚è¦: $(echo "$RESPONSE_BODY" | head -c 200)..."
            else
              echo "ğŸ“„ é”™è¯¯å“åº”å¤ªé•¿ï¼Œå·²çœç•¥æ˜¾ç¤º"
            fi
            
            # æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            echo "ğŸ’¡ å¯èƒ½çš„åŸå› :"
            echo "   - RenderæœåŠ¡æ­£åœ¨å†·å¯åŠ¨ (é€šå¸¸éœ€è¦30-60ç§’)"
            echo "   - æœåŠ¡å‡ºç°ä¸´æ—¶æ•…éšœ"
            echo "   - ç½‘ç»œè¿æ¥é—®é¢˜"
            echo "   - ç­¾åéªŒè¯é—®é¢˜"
            
            # è®¾ç½®è¾“å‡ºä½†ä¸ç«‹å³é€€å‡ºï¼Œè®©åç»­æ­¥éª¤èƒ½å¤Ÿå¤„ç†
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "api_failed=true" >> $GITHUB_OUTPUT
          fi

      - name: âš ï¸ å¤„ç†APIè°ƒç”¨å¤±è´¥
        if: steps.get_files.outputs.api_failed == 'true'
        run: |
          echo "âš ï¸ å¤‡ä»½APIè°ƒç”¨å¤±è´¥ï¼Œä½†ä¸ä¸­æ–­å·¥ä½œæµ"
          echo "ğŸ” æ•…éšœæ’æŸ¥å»ºè®®:"
          echo "   1. æ£€æŸ¥RenderæœåŠ¡çŠ¶æ€: https://render.com/status"
          echo "   2. æ£€æŸ¥æœåŠ¡æ—¥å¿—: https://dashboard.render.com"
          echo "   3. ç¡®è®¤æœåŠ¡æ˜¯å¦æ­£åœ¨å†·å¯åŠ¨"
          echo "   4. éªŒè¯BACKUP_SECRETé…ç½®æ˜¯å¦æ­£ç¡®"
          echo ""
          echo "ğŸ“Š å¥åº·æ£€æŸ¥ç»“æœ: ${{ steps.health_check.outputs.service_ready }}"
          echo "ğŸ• ä¸‹æ¬¡å®šæ—¶ä»»åŠ¡å°†åœ¨1å°æ—¶åè‡ªåŠ¨é‡è¯•"
          echo ""
          echo "ğŸ’¡ è¿™æ˜¯å…è´¹Renderå®ä¾‹çš„æ­£å¸¸ç°è±¡ï¼ŒæœåŠ¡ä¼šåœ¨æ— æ´»åŠ¨æ—¶ä¼‘çœ "

      - name: ğŸ“ å†™å…¥æ–‡ä»¶åˆ°ä»“åº“
        if: steps.get_files.outputs.has_files == 'true'
        run: |
          echo "ğŸ“ å¼€å§‹å†™å…¥æ–‡ä»¶åˆ°ä»“åº“..."
          
          # ç¡®ä¿logç›®å½•å­˜åœ¨
          mkdir -p log
          
          # è®°å½•å†™å…¥å‰çš„çŠ¶æ€
          echo "ğŸ“‹ å†™å…¥å‰çš„logç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la log/ || echo "logç›®å½•ä¸ºç©º"
          
          # ä½¿ç”¨Pythonè„šæœ¬å¤„ç†JSONå¹¶å†™å…¥æ–‡ä»¶
          python3 -c "
          import json
          import os
          import hashlib
          
          # è¯»å–APIå“åº”
          with open('backup_response.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          if not data.get('ok', False):
              print('âŒ APIå“åº”è¡¨ç¤ºæ“ä½œå¤±è´¥')
              exit(1)
          
          files = data.get('files', {})
          if not files:
              print('â„¹ï¸  æ²¡æœ‰æ–‡ä»¶éœ€è¦å†™å…¥')
              exit(0)
          
          # å†™å…¥æ¯ä¸ªæ–‡ä»¶
          files_written = 0
          files_updated = 0
          files_unchanged = 0
          
          for filename, file_info in files.items():
              filepath = file_info['path']
              content = file_info['content']
              
              # ç¡®ä¿ç›®å½•å­˜åœ¨
              os.makedirs(os.path.dirname(filepath), exist_ok=True)
              
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ä¸”å†…å®¹ç›¸åŒ
              file_exists = os.path.exists(filepath)
              content_changed = True
              
              if file_exists:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      existing_content = f.read()
                  content_changed = existing_content != content
              
              # å†™å…¥æ–‡ä»¶
              with open(filepath, 'w', encoding='utf-8') as f:
                  f.write(content)
              
              # ç»Ÿè®¡
              if not file_exists:
                  files_written += 1
                  print(f'âœ… æ–°å»ºæ–‡ä»¶: {filepath} ({file_info[\"size\"]} å­—ç¬¦)')
              elif content_changed:
                  files_updated += 1
                  print(f'âœ… æ›´æ–°æ–‡ä»¶: {filepath} ({file_info[\"size\"]} å­—ç¬¦)')
              else:
                  files_unchanged += 1
                  print(f'â„¹ï¸  æ–‡ä»¶æ— å˜åŒ–: {filepath} ({file_info[\"size\"]} å­—ç¬¦)')
          
          print(f'ğŸ‰ å¤„ç†å®Œæˆ: æ–°å»º{files_written}ä¸ª, æ›´æ–°{files_updated}ä¸ª, æ— å˜åŒ–{files_unchanged}ä¸ª')
          print(f'ğŸ“Š æ€»è®¡: {len(files)} ä¸ªæ–‡ä»¶')
          "
          
          # è®°å½•å†™å…¥åçš„çŠ¶æ€
          echo "ğŸ“‹ å†™å…¥åçš„logç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la log/
          
          # æ˜¾ç¤ºGitå¯¹è¿™äº›æ–‡ä»¶çš„æ„ŸçŸ¥
          echo "ğŸ“ Gitå¯¹logç›®å½•çš„çŠ¶æ€æ„ŸçŸ¥:"
          git status log/ || echo "Gitæ— æ³•è·å–logç›®å½•çŠ¶æ€"

      - name: ğŸ” æ£€æŸ¥Gitå˜æ›´
        if: steps.get_files.outputs.has_files == 'true'
        id: check_changes
        run: |
          echo "ğŸ” è¯¦ç»†æ£€æŸ¥GitçŠ¶æ€..."
          
          # æ˜¾ç¤ºå½“å‰GitçŠ¶æ€
          echo "ğŸ“‹ GitçŠ¶æ€æ¦‚è§ˆ:"
          git status
          
          # æ˜¾ç¤ºæœªæš‚å­˜çš„å˜æ›´
          echo "ğŸ“ æœªæš‚å­˜çš„å˜æ›´:"
          git diff --name-only || echo "æ— æœªæš‚å­˜å˜æ›´"
          
          # æ˜¾ç¤ºå·²æš‚å­˜çš„å˜æ›´  
          echo "ğŸ“ å·²æš‚å­˜çš„å˜æ›´:"
          git diff --cached --name-only || echo "æ— å·²æš‚å­˜å˜æ›´"
          
          # æ˜¾ç¤ºæœªè·Ÿè¸ªçš„æ–‡ä»¶
          echo "ğŸ“ æœªè·Ÿè¸ªçš„æ–‡ä»¶:"
          git ls-files --others --exclude-standard || echo "æ— æœªè·Ÿè¸ªæ–‡ä»¶"
          
          # æ£€æŸ¥logç›®å½•çš„å…·ä½“å˜æ›´
          echo "ğŸ“ logç›®å½•å˜æ›´è¯¦æƒ…:"
          git status --porcelain log/ || echo "logç›®å½•æ— å˜æ›´"
          
          # æ‰‹åŠ¨æ·»åŠ æ‰€æœ‰logç›®å½•çš„åˆ†ææ–‡ä»¶
          echo "ğŸ“¤ æ‰‹åŠ¨æ·»åŠ logç›®å½•çš„åˆ†ææ–‡ä»¶..."
          
          # ä½¿ç”¨findå‘½ä»¤ç¡®ä¿æ‰€æœ‰åˆ†ææ–‡ä»¶éƒ½è¢«æ·»åŠ 
          find log -name "*-analysis*.md" -type f -exec git add {} \; 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åˆ†ææ–‡ä»¶"
          
          # å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥æ·»åŠ æ•´ä¸ªlogç›®å½•
          git add log/ 2>/dev/null || echo "æ·»åŠ logç›®å½•å¤±è´¥"
          
          # å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬å·²æš‚å­˜çš„ï¼‰
          # è·å–å·²æš‚å­˜çš„æ–‡ä»¶åˆ—è¡¨
          STAGED_FILES=$(git diff --cached --name-only)
          
          if [ -z "$STAGED_FILES" ]; then
            echo "â„¹ï¸  ç¡®è®¤æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼ˆå·²æš‚å­˜ï¼‰"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå³å°†æäº¤çš„å˜æ›´
            echo "ğŸ“‹ å³å°†æäº¤çš„æ–‡ä»¶:"
            echo "$STAGED_FILES"
            
            # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
            echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
            git diff --cached --stat
            
            # æ˜¾ç¤ºå˜æ›´æ•°é‡
            FILE_COUNT=$(echo "$STAGED_FILES" | wc -l)
            echo "ğŸ“Š å˜æ›´æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          fi

      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ’¾ æäº¤æ–‡ä»¶å˜æ›´..."
          
          # æ·»åŠ æ‰€æœ‰logç›®å½•çš„åˆ†ææ–‡ä»¶
          git add log/*-analysis*.md
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MESSAGE="Log: Auto Update $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“ æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
          
          # æäº¤
          git commit -m "$COMMIT_MESSAGE"
          
          # æ¨é€
          echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          
          # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨è¯¦ç»†é”™è¯¯ä¿¡æ¯
          if ! git push origin main; then
            echo "âŒ æ¨é€å¤±è´¥ï¼Œå°è¯•è¯Šæ–­é—®é¢˜..."
            echo "ğŸ” å½“å‰è¿œç¨‹é…ç½®:"
            git remote -v
            echo "ğŸ” å½“å‰åˆ†æ”¯ä¿¡æ¯:"
            git branch -v
            echo "ğŸ” Gitå‡­æ®é…ç½®:"
            git config --list | grep -E "(user|credential|remote)" || echo "æ— ç›¸å…³é…ç½®"
            
            # å°è¯•é‡æ–°é…ç½®è¿œç¨‹URL
            echo "ğŸ”§ é‡æ–°é…ç½®è¿œç¨‹URL..."
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            
            # å†æ¬¡å°è¯•æ¨é€
            echo "ğŸ”„ é‡æ–°å°è¯•æ¨é€..."
            git push origin main
          fi
          
          echo "âœ… å¤‡ä»½æäº¤æ¨é€æˆåŠŸ!"

      - name: ğŸ“Š å¤‡ä»½ç»Ÿè®¡
        if: always()
        run: |
          echo "ğŸ‰ è‡ªåŠ¨å¤‡ä»½ä»»åŠ¡å®Œæˆ!"
          echo ""
          echo "ğŸ“ˆ è¿è¡Œç»Ÿè®¡:"
          echo "   - æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   - åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo "   - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "   - è¿è¡ŒID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ©º æœåŠ¡çŠ¶æ€:"
          echo "   - RenderæœåŠ¡å°±ç»ª: ${{ steps.health_check.outputs.service_ready || 'æœªçŸ¥' }}"
          echo "   - APIè°ƒç”¨çŠ¶æ€: ${{ steps.get_files.outputs.api_failed == 'true' && 'å¤±è´¥' || 'æˆåŠŸ' }}"
          echo "   - æ–‡ä»¶æ•°é‡: ${{ steps.get_files.outputs.file_count || '0' }}"
          echo "   - Gitå˜æ›´: ${{ steps.check_changes.outputs.has_changes || 'false' }}"
          echo ""
          echo "â° ä¸‹æ¬¡è¿è¡Œ:"
          echo "   - å®šæ—¶æ‰§è¡Œ: 1å°æ—¶å"
          echo "   - æ‰‹åŠ¨è§¦å‘: éšæ—¶å¯åœ¨Actionsé¡µé¢æ‰§è¡Œ"
          echo ""
          echo "ğŸ’¡ å¤‡ä»½æ–¹å¼: Render API â†’ GitHub Actions â†’ Git Repository"
          
          # æ ¹æ®ç»“æœçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
          if [ "${{ steps.get_files.outputs.api_failed }}" = "true" ]; then
            echo ""
            echo "âš ï¸  æœ¬æ¬¡å¤‡ä»½å› APIè°ƒç”¨å¤±è´¥è€Œè·³è¿‡ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡"
            echo "ğŸ”„ ç³»ç»Ÿå°†åœ¨ä¸‹ä¸€ä¸ªå®šæ—¶å‘¨æœŸè‡ªåŠ¨é‡è¯•"
          elif [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo ""
            echo "âœ… æœ¬æ¬¡å¤‡ä»½æˆåŠŸå®Œæˆï¼Œæ–°æ–‡ä»¶å·²æäº¤åˆ°ä»“åº“"
          else
            echo ""
            echo "â„¹ï¸  æœ¬æ¬¡æ£€æŸ¥æ— æ–°æ–‡ä»¶éœ€è¦å¤‡ä»½"
          fi

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f backup_response.json