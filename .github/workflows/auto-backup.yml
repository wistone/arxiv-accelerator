name: è‡ªåŠ¨å¤‡ä»½æ—¥å¿—åˆ†ææ–‡ä»¶

on:
  schedule:
    # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡å¤‡ä»½ (UTCæ—¶é—´)
    - cron: '0 */1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
  actions: read    # å…è®¸è¯»å–Actions

jobs:
  backup-logs:
    runs-on: ubuntu-latest
    name: å¤‡ä»½åˆ†ææ–‡ä»¶åˆ°Git
    
    steps:
      - name: ğŸ” æ£€æŸ¥ä»“åº“ç¯å¢ƒ
        run: |
          echo "ğŸ“Š GitHub Actionsç¯å¢ƒä¿¡æ¯:"
          echo "   - ä»“åº“: ${{ github.repository }}"
          echo "   - åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   - è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "   - å·¥ä½œæµ: ${{ github.workflow }}"
          echo "   - è¿è¡ŒID: ${{ github.run_id }}"

      - name: ğŸ” éªŒè¯å¯†é’¥é…ç½®
        run: |
          if [ -z "${{ secrets.BACKUP_SECRET }}" ]; then
            echo "âŒ é”™è¯¯: BACKUP_SECRETæœªé…ç½®"
            echo "ğŸ’¡ è¯·åœ¨ä»“åº“Settings â†’ Secretsä¸­æ·»åŠ BACKUP_SECRETå¯†é’¥"
            exit 1
          fi
          echo "âœ… å¤‡ä»½å¯†é’¥å·²é…ç½®"

      - name: ğŸ“¥ Checkout ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ”§ é…ç½® Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: ğŸŒ è·å–RenderæœåŠ¡å™¨çš„æ–‡ä»¶
        id: get_files
        run: |
          echo "ğŸš€ å¼€å§‹ä»Renderè·å–åˆ†ææ–‡ä»¶..."
          
          # è®¡ç®—HMACç­¾å
          SIGNATURE=$(echo -n "run" | openssl dgst -sha256 -hmac "${{ secrets.BACKUP_SECRET }}" | cut -d' ' -f2)
          echo "ğŸ” ç­¾åå·²ç”Ÿæˆ"
          
          # è®¾ç½®è°ƒè¯•æ¨¡å¼
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            echo "ğŸ› è°ƒè¯•æ¨¡å¼å·²å¯ç”¨"
            CURL_OPTIONS="-v"
          else
            CURL_OPTIONS="-s"
          fi
          
          # è°ƒç”¨å¤‡ä»½APIè·å–æ–‡ä»¶
          echo "ğŸ“¡ è°ƒç”¨å¤‡ä»½API..."
          RESPONSE=$(curl -X POST \
            -H "X-Backup-Sign: $SIGNATURE" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Backup-Bot/1.0" \
            $CURL_OPTIONS \
            -w "HTTP_STATUS:%{http_code}" \
            https://arxiv-accelerator.onrender.com/internal/backup)
          
          # è§£æå“åº”
          HTTP_STATUS=$(echo "$RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          echo "ğŸ“Š APIå“åº”çŠ¶æ€: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… æˆåŠŸè·å–æ–‡ä»¶åˆ—è¡¨!"
            
            # ä¿å­˜å“åº”åˆ°æ–‡ä»¶
            echo "$RESPONSE_BODY" > backup_response.json
            
            # è§£ææ–‡ä»¶æ•°é‡
            FILE_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.file_count // 0')
            echo "ğŸ“„ æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "has_files=true" >> $GITHUB_OUTPUT
              echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            else
              echo "has_files=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  æ²¡æœ‰éœ€è¦å¤‡ä»½çš„æ–‡ä»¶"
            fi
          else
            echo "âŒ è·å–æ–‡ä»¶å¤±è´¥!"
            echo "ğŸ“„ é”™è¯¯å“åº”: $RESPONSE_BODY"
            
            # æ ¹æ®çŠ¶æ€ç æä¾›å…·ä½“çš„é”™è¯¯ä¿¡æ¯
            case $HTTP_STATUS in
              403)
                echo "ğŸ’¡ ç­¾åéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥BACKUP_SECRETå¯†é’¥æ˜¯å¦æ­£ç¡®"
                ;;
              404)
                echo "ğŸ’¡ å¤‡ä»½APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·ç¡®è®¤æœåŠ¡å™¨éƒ¨ç½²æ­£å¸¸"
                ;;
              500)
                echo "ğŸ’¡ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥RenderæœåŠ¡æ—¥å¿—"
                ;;
              000)
                echo "ğŸ’¡ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå¯èƒ½æœåŠ¡å™¨æ­£åœ¨ç¡çœ çŠ¶æ€"
                echo "ğŸ”„ å°è¯•å†æ¬¡è°ƒç”¨ä»¥å”¤é†’æœåŠ¡..."
                sleep 10
                # é‡è¯•ä¸€æ¬¡
                RETRY_RESPONSE=$(curl -X POST \
                  -H "X-Backup-Sign: $SIGNATURE" \
                  -H "Content-Type: application/json" \
                  $CURL_OPTIONS \
                  -w "HTTP_STATUS:%{http_code}" \
                  https://arxiv-accelerator.onrender.com/internal/backup)
                
                RETRY_STATUS=$(echo "$RETRY_RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
                if [ "$RETRY_STATUS" = "200" ]; then
                  echo "âœ… é‡è¯•æˆåŠŸ!"
                  RETRY_BODY=$(echo "$RETRY_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
                  echo "$RETRY_BODY" > backup_response.json
                  FILE_COUNT=$(echo "$RETRY_BODY" | jq -r '.file_count // 0')
                  if [ "$FILE_COUNT" -gt 0 ]; then
                    echo "has_files=true" >> $GITHUB_OUTPUT
                    echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
                  else
                    echo "has_files=false" >> $GITHUB_OUTPUT
                  fi
                else
                  echo "âŒ é‡è¯•ä¹Ÿå¤±è´¥äº†"
                  exit 1
                fi
                ;;
            esac
            
            if [ "$HTTP_STATUS" != "000" ]; then
              exit 1
            fi
          fi

      - name: ğŸ“ å†™å…¥æ–‡ä»¶åˆ°ä»“åº“
        if: steps.get_files.outputs.has_files == 'true'
        run: |
          echo "ğŸ“ å¼€å§‹å†™å…¥æ–‡ä»¶åˆ°ä»“åº“..."
          
          # ç¡®ä¿logç›®å½•å­˜åœ¨
          mkdir -p log
          
          # è®°å½•å†™å…¥å‰çš„çŠ¶æ€
          echo "ğŸ“‹ å†™å…¥å‰çš„logç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la log/ || echo "logç›®å½•ä¸ºç©º"
          
          # ä½¿ç”¨Pythonè„šæœ¬å¤„ç†JSONå¹¶å†™å…¥æ–‡ä»¶
          python3 -c "
          import json
          import os
          import hashlib
          
          # è¯»å–APIå“åº”
          with open('backup_response.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          if not data.get('ok', False):
              print('âŒ APIå“åº”è¡¨ç¤ºæ“ä½œå¤±è´¥')
              exit(1)
          
          files = data.get('files', {})
          if not files:
              print('â„¹ï¸  æ²¡æœ‰æ–‡ä»¶éœ€è¦å†™å…¥')
              exit(0)
          
          # å†™å…¥æ¯ä¸ªæ–‡ä»¶
          files_written = 0
          files_updated = 0
          files_unchanged = 0
          
          for filename, file_info in files.items():
              filepath = file_info['path']
              content = file_info['content']
              
              # ç¡®ä¿ç›®å½•å­˜åœ¨
              os.makedirs(os.path.dirname(filepath), exist_ok=True)
              
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ä¸”å†…å®¹ç›¸åŒ
              file_exists = os.path.exists(filepath)
              content_changed = True
              
              if file_exists:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      existing_content = f.read()
                  content_changed = existing_content != content
              
              # å†™å…¥æ–‡ä»¶
              with open(filepath, 'w', encoding='utf-8') as f:
                  f.write(content)
              
              # ç»Ÿè®¡
              if not file_exists:
                  files_written += 1
                  print(f'âœ… æ–°å»ºæ–‡ä»¶: {filepath} ({file_info[\"size\"]} å­—ç¬¦)')
              elif content_changed:
                  files_updated += 1
                  print(f'âœ… æ›´æ–°æ–‡ä»¶: {filepath} ({file_info[\"size\"]} å­—ç¬¦)')
              else:
                  files_unchanged += 1
                  print(f'â„¹ï¸  æ–‡ä»¶æ— å˜åŒ–: {filepath} ({file_info[\"size\"]} å­—ç¬¦)')
          
          print(f'ğŸ‰ å¤„ç†å®Œæˆ: æ–°å»º{files_written}ä¸ª, æ›´æ–°{files_updated}ä¸ª, æ— å˜åŒ–{files_unchanged}ä¸ª')
          print(f'ğŸ“Š æ€»è®¡: {len(files)} ä¸ªæ–‡ä»¶')
          "
          
          # è®°å½•å†™å…¥åçš„çŠ¶æ€
          echo "ğŸ“‹ å†™å…¥åçš„logç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la log/
          
          # æ˜¾ç¤ºGitå¯¹è¿™äº›æ–‡ä»¶çš„æ„ŸçŸ¥
          echo "ğŸ“ Gitå¯¹logç›®å½•çš„çŠ¶æ€æ„ŸçŸ¥:"
          git status log/ || echo "Gitæ— æ³•è·å–logç›®å½•çŠ¶æ€"

      - name: ğŸ” æ£€æŸ¥Gitå˜æ›´
        if: steps.get_files.outputs.has_files == 'true'
        id: check_changes
        run: |
          echo "ğŸ” è¯¦ç»†æ£€æŸ¥GitçŠ¶æ€..."
          
          # æ˜¾ç¤ºå½“å‰GitçŠ¶æ€
          echo "ğŸ“‹ GitçŠ¶æ€æ¦‚è§ˆ:"
          git status
          
          # æ˜¾ç¤ºæœªæš‚å­˜çš„å˜æ›´
          echo "ğŸ“ æœªæš‚å­˜çš„å˜æ›´:"
          git diff --name-only || echo "æ— æœªæš‚å­˜å˜æ›´"
          
          # æ˜¾ç¤ºå·²æš‚å­˜çš„å˜æ›´  
          echo "ğŸ“ å·²æš‚å­˜çš„å˜æ›´:"
          git diff --cached --name-only || echo "æ— å·²æš‚å­˜å˜æ›´"
          
          # æ˜¾ç¤ºæœªè·Ÿè¸ªçš„æ–‡ä»¶
          echo "ğŸ“ æœªè·Ÿè¸ªçš„æ–‡ä»¶:"
          git ls-files --others --exclude-standard || echo "æ— æœªè·Ÿè¸ªæ–‡ä»¶"
          
          # æ£€æŸ¥logç›®å½•çš„å…·ä½“å˜æ›´
          echo "ğŸ“ logç›®å½•å˜æ›´è¯¦æƒ…:"
          git status --porcelain log/ || echo "logç›®å½•æ— å˜æ›´"
          
          # æ‰‹åŠ¨æ·»åŠ æ‰€æœ‰logç›®å½•çš„åˆ†ææ–‡ä»¶
          echo "ğŸ“¤ æ‰‹åŠ¨æ·»åŠ logç›®å½•çš„åˆ†ææ–‡ä»¶..."
          
          # ä½¿ç”¨findå‘½ä»¤ç¡®ä¿æ‰€æœ‰åˆ†ææ–‡ä»¶éƒ½è¢«æ·»åŠ 
          find log -name "*-analysis*.md" -type f -exec git add {} \; 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åˆ†ææ–‡ä»¶"
          
          # å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥æ·»åŠ æ•´ä¸ªlogç›®å½•
          git add log/ 2>/dev/null || echo "æ·»åŠ logç›®å½•å¤±è´¥"
          
          # å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬å·²æš‚å­˜çš„ï¼‰
          # è·å–å·²æš‚å­˜çš„æ–‡ä»¶åˆ—è¡¨
          STAGED_FILES=$(git diff --cached --name-only)
          
          if [ -z "$STAGED_FILES" ]; then
            echo "â„¹ï¸  ç¡®è®¤æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼ˆå·²æš‚å­˜ï¼‰"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå³å°†æäº¤çš„å˜æ›´
            echo "ğŸ“‹ å³å°†æäº¤çš„æ–‡ä»¶:"
            echo "$STAGED_FILES"
            
            # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
            echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
            git diff --cached --stat
            
            # æ˜¾ç¤ºå˜æ›´æ•°é‡
            FILE_COUNT=$(echo "$STAGED_FILES" | wc -l)
            echo "ğŸ“Š å˜æ›´æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          fi

      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ’¾ æäº¤æ–‡ä»¶å˜æ›´..."
          
          # æ·»åŠ æ‰€æœ‰logç›®å½•çš„åˆ†ææ–‡ä»¶
          git add log/*-analysis*.md
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MESSAGE="Log: Auto Update $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“ æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
          
          # æäº¤
          git commit -m "$COMMIT_MESSAGE"
          
          # æ¨é€
          echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          
          # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨è¯¦ç»†é”™è¯¯ä¿¡æ¯
          if ! git push origin main; then
            echo "âŒ æ¨é€å¤±è´¥ï¼Œå°è¯•è¯Šæ–­é—®é¢˜..."
            echo "ğŸ” å½“å‰è¿œç¨‹é…ç½®:"
            git remote -v
            echo "ğŸ” å½“å‰åˆ†æ”¯ä¿¡æ¯:"
            git branch -v
            echo "ğŸ” Gitå‡­æ®é…ç½®:"
            git config --list | grep -E "(user|credential|remote)" || echo "æ— ç›¸å…³é…ç½®"
            
            # å°è¯•é‡æ–°é…ç½®è¿œç¨‹URL
            echo "ğŸ”§ é‡æ–°é…ç½®è¿œç¨‹URL..."
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            
            # å†æ¬¡å°è¯•æ¨é€
            echo "ğŸ”„ é‡æ–°å°è¯•æ¨é€..."
            git push origin main
          fi
          
          echo "âœ… å¤‡ä»½æäº¤æ¨é€æˆåŠŸ!"

      - name: ğŸ“Š å¤‡ä»½ç»Ÿè®¡
        if: always()
        run: |
          echo "ğŸ‰ è‡ªåŠ¨å¤‡ä»½ä»»åŠ¡å®Œæˆ!"
          echo "ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯:"
          echo "   - æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   - åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo "   - æ–‡ä»¶æ•°é‡: ${{ steps.get_files.outputs.file_count || '0' }}"
          echo "   - æ˜¯å¦æœ‰å˜æ›´: ${{ steps.check_changes.outputs.has_changes || 'false' }}"
          echo "   - ä¸‹æ¬¡æ‰§è¡Œ: 1å°æ—¶å"
          echo "   - å¤‡ä»½æ–¹å¼: Render API â†’ GitHub Actions Git"

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f backup_response.json